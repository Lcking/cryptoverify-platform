# Replace the example domains with your real domains

app.gambleverify.com {
  encode zstd gzip
  root * /srv/www
  
  # Cache static assets for 1 year, but always revalidate HTML
  @static path *.js *.css *.woff2 *.woff *.ttf *.eot *.ico *.svg *.png *.jpg *.jpeg *.gif *.webp
  header @static Cache-Control "public, max-age=31536000, immutable"
  
  @html path *.html /
  header @html Cache-Control "public, max-age=0, must-revalidate"
  
  try_files {path} /index.html
  file_server
}

# Redirect www and apex to the canonical app domain
www.gambleverify.com {
  redir https://app.gambleverify.com{uri} 301
}

gambleverify.com {
  redir https://app.gambleverify.com{uri} 301
}

api.gambleverify.com {
  encode zstd gzip
  
  # CORS headers must be set BEFORE handling OPTIONS
  header {
    Access-Control-Allow-Origin "https://app.gambleverify.com"
    Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"
    Access-Control-Allow-Credentials "true"
    Access-Control-Max-Age "86400"
  }
  
  # Handle CORS preflight requests (after headers are set)
  @options method OPTIONS
  respond @options 204
  
  reverse_proxy strapi:1337 {
    # Ensure Strapi sees the original scheme/host for secure cookies
    # IMPORTANT: {scheme} here would be the upstream scheme (http). We must force https.
    header_up X-Forwarded-Proto https
    header_up X-Forwarded-Host {host}
    header_up Host {host}
    header_up X-Forwarded-Port 443
    header_up X-Forwarded-For {remote}
  }
}
