# Replace the example domains with your real domains

app.gambleverify.com {
  encode zstd gzip
  root * /srv/www
  
  # Cache static assets for 1 year, but always revalidate HTML
  @static path *.js *.css *.woff2 *.woff *.ttf *.eot *.ico *.svg *.png *.jpg *.jpeg *.gif *.webp
  header @static Cache-Control "public, max-age=31536000, immutable"
  
  @html path *.html /
  header @html Cache-Control "public, max-age=0, must-revalidate"
  
  try_files {path} /index.html
  file_server
}

# Redirect www and apex to the canonical app domain
www.gambleverify.com {
  redir https://app.gambleverify.com{uri} 301
}

gambleverify.com {
  redir https://app.gambleverify.com{uri} 301
}

api.gambleverify.com {
  encode zstd gzip
  
  # Let Strapi handle CORS - don't set headers here to avoid duplication
  # Strapi's CORS middleware is configured in backend/config/middlewares.ts
  
  reverse_proxy strapi:1337 {
    # Ensure Strapi sees the original scheme/host for secure cookies
    # IMPORTANT: {scheme} here would be the upstream scheme (http). We must force https.
    header_up X-Forwarded-Proto https
    header_up X-Forwarded-Host {host}
    header_up Host {host}
    header_up X-Forwarded-Port 443
    header_up X-Forwarded-For {remote}
  }
}
